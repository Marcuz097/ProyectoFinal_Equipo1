<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Agenda del Médico</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <i class="bi bi-calendar2-week"></i> Agenda del Médico
      </a>
      <span class="navbar-text">
        {{ medico.usuario.first_name }} {{ medico.usuario.last_name }}
      </span>
    </div>
  </nav>

  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3>
        <i class="bi bi-calendar-week"></i> Agenda de {{ medico.usuario.first_name }} {{ medico.usuario.last_name }}
      </h3>
      <small class="text-muted">Hoy: {{ now|date:"Y-m-d H:i" }}</small>
    </div>

    {% if dias_ordenados %}
      {% for dia, citas in dias_ordenados %}
        <div class="card mb-4">
          <div class="card-header">
            {% if dia %}
              <i class="bi bi-calendar-day"></i> {{ dia|date:"l, d F Y" }}
            {% else %}
              <i class="bi bi-calendar-x"></i> Fecha no definida
            {% endif %}
          </div>
          <div class="card-body">
            <div class="list-group">
              {% for cita in citas %}
                <div class="list-group-item">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="mb-1">
                        <i class="bi bi-clock"></i> {{ cita.fecha_hora|date:"H:i" }} —
                        <span class="fw-bold">{{ cita.paciente.usuario.get_full_name }}</span>
                      </h6>
                      <p class="mb-0 text-muted small">
                        <i class="bi bi-chat-left-dots"></i> Motivo: {{ cita.motivo|default:"(sin especificar)" }}
                      </p>
                    </div>

                    <div class="text-end">
                      {% if cita.estado == "Pendiente" %}
                        <span class="badge bg-secondary mb-2">{{ cita.estado }}</span>
                      {% elif cita.estado == "Confirmada" %}
                        <span class="badge bg-primary mb-2">{{ cita.estado }}</span>
                      {% elif cita.estado == "Completada" %}
                        <span class="badge bg-success mb-2">{{ cita.estado }}</span>
                      {% elif cita.estado == "Cancelada" %}
                        <span class="badge bg-danger mb-2">{{ cita.estado }}</span>
                      {% else %}
                        <span class="badge bg-info mb-2">{{ cita.estado }}</span>
                      {% endif %}

                      <form class="form-estado" data-cita="{{ cita.pk }}">
                        <div class="input-group input-group-sm">
                          <select class="form-select estado-select">
                            <option value="Pendiente" {% if cita.estado == "Pendiente" %}selected{% endif %}>Pendiente</option>
                            <option value="Confirmada" {% if cita.estado == "Confirmada" %}selected{% endif %}>Confirmada</option>
                            <option value="Completada" {% if cita.estado == "Completada" %}selected{% endif %}>Completada</option>
                            <option value="Cancelada" {% if cita.estado == "Cancelada" %}selected{% endif %}>Cancelada</option>
                          </select>
                          <button type="button" class="btn btn-outline-secondary btn-guardar-estado">
                            <i class="bi bi-save"></i>
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-info text-center">
        <i class="bi bi-info-circle"></i> No hay citas programadas.
      </div>
    {% endif %}
  </div>

  <footer class="bg-primary text-white text-center py-3 mt-5">
    &copy; {{ now|date:"Y" }} Sistema de Gestión de Citas Médicas
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script para actualizar estado -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      document.querySelectorAll('.btn-guardar-estado').forEach(function (btn) {
        btn.addEventListener('click', function (e) {
          const form = e.target.closest('.form-estado');
          const citaId = form.getAttribute('data-cita');
          const estado = form.querySelector('.estado-select').value;

          const csrftoken = (function() {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, 10) === ('csrftoken=')) {
                  cookieValue = decodeURIComponent(cookie.substring(10));
                  break;
                }
              }
            }
            return cookieValue;
          })();

          fetch("{% url 'medico-actualizar-estado' %}", {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrftoken,
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
              'cita_id': citaId,
              'estado': estado
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.ok) {
              const alertDiv = document.createElement('div');
              alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
              alertDiv.innerHTML = `
                <i class="bi bi-check-circle"></i> Estado actualizado correctamente.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              `;
              document.body.appendChild(alertDiv);
              setTimeout(() => window.location.reload(), 1000);
            } else {
              alert('Error: ' + (data.error || 'No se pudo actualizar.'));
            }
          })
          .catch(err => alert('Error de conexión con el servidor.'));
        });
      });
    });
  </script>
</body>
</html>