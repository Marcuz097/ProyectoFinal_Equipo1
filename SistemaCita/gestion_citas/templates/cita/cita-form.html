{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block titulo %}
  {% if form.instance.pk %}Editar Cita{% else %}Nueva Cita{% endif %}
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'core/css/CSS-personalizado/cita-form.css' %}">
  <style>
    .is-invalid + .invalid-feedback { display:block; }
  </style>
{% endblock %}

{% block contenido %}
<div class="container mt-1 d-flex justify-content-center">
  <div class="card card-shadow-innovador" style="max-width: 720px; width:100%;">
    <div class="card-header card-header-navy text-white text-center">
      <h2 class="card-title">
        <i class="bi bi-calendar-plus-fill me-2"></i>
        {% if form.instance.pk %}Editar Cita{% else %}Registrar Nueva Cita{% endif %}
      </h2>
    </div>

    <form method="post" novalidate>
      <div class="card-body">
        {% csrf_token %}

        {% if form.non_field_errors %}
          <div class="alert alert-danger">{{ form.non_field_errors }}</div>
        {% endif %}

        {% for field in form %}
          <p class="mb-3">
            <label for="{{ field.id_for_label }}" class="form-label">
              {% if field.name == 'paciente' %}
                <i class="bi bi-person-fill text-contrast-blue"></i> Paciente
              {% elif field.name == 'medico' %}
                <i class="bi bi-person-badge-fill text-contrast-blue"></i> Médico
              {% elif field.name == 'fecha_hora' %}
                <i class="bi bi-calendar-date-fill text-contrast-blue"></i> Fecha y Hora
              {% elif field.name == 'motivo' %}
                <i class="bi bi-chat-dots-fill text-contrast-blue"></i> Motivo
              {% elif field.name == 'estado' %}
                <i class="bi bi-activity text-contrast-blue"></i> Estado
              {% else %}
                {{ field.label }}
              {% endif %}
            </label>

            {# Select Paciente / Médico #}
            {% if field.name == 'paciente' or field.name == 'medico' %}
              <select name="{{ field.name }}" id="{{ field.id_for_label }}" class="form-select">
                <option value="" {% if not field.value %}selected{% endif %} disabled>-- Seleccionar --</option>
                {% for obj in field.field.queryset %}
                  <option value="{{ obj.pk }}" {% if field.value|stringformat:"s" == obj.pk|stringformat:"s" %}selected{% endif %}>
                    {% if field.name == 'medico' %}Dr(a). {% endif %}{{ obj.usuario.first_name }} {{ obj.usuario.last_name }}
                  </option>
                {% endfor %}
              </select>
              <div class="invalid-feedback" style="display:none"></div>
              {% if field.errors %}
                <div class="invalid-feedback" style="display:block">{{ field.errors|striptags }}</div>
              {% endif %}

            {# Select Estado con opción vacía y todas las choices #}
            {% elif field.name == 'estado' %}
              <select name="{{ field.name }}" id="{{ field.id_for_label }}" class="form-select">
                <option value="" {% if not field.value %}selected{% endif %} disabled>-- Seleccionar --</option>
                {% for value,label in field.field.choices %}
                  <option value="{{ value }}" {% if field.value|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endfor %}
              </select>
              <div class="invalid-feedback" style="display:none"></div>
              {% if field.errors %}
                <div class="invalid-feedback" style="display:block">{{ field.errors|striptags }}</div>
              {% endif %}

            {# Textarea Motivo #}
            {% elif field.name == 'motivo' %}
              <textarea name="{{ field.name }}" id="{{ field.id_for_label }}" class="form-control" rows="2"
                        placeholder="Describa brevemente el motivo de la cita...">{{ field.value|default_if_none:'' }}</textarea>
              <div class="invalid-feedback" style="display:none"></div>
              {% if field.errors %}
                <div class="invalid-feedback" style="display:block">{{ field.errors|striptags }}</div>
              {% endif %}

            {# Resto de campos (incluye fecha_hora si no lo personalizas) #}
            {% else %}
              {% render_field field class+="form-control" %}
              <div class="invalid-feedback" style="display:none"></div>
              {% if field.errors %}
                <div class="invalid-feedback" style="display:block">{{ field.errors|striptags }}</div>
              {% endif %}
            {% endif %}

            {% if field.help_text %}
              <small class="form-text text-muted">{{ field.help_text }}</small>
            {% endif %}
          </p>
        {% endfor %}
      </div>

      <div class="card-footer d-flex justify-content-center gap-4 py-3 bg-light">
        <button type="submit" class="btn btn-principal">
          <i class="bi bi-save-fill me-1"></i> Guardar
        </button>
        <a href="{% url 'gestion_citas:cita-list' %}" class="btn btn-secundario-outline">
          <i class="bi bi-x-circle-fill me-1"></i> Cancelar
        </a>
      </div>
    </form>
  </div>
</div>

<script>
  // IDs (ajusta si tu HTML usa otros)
  const FIELDS = ['id_fecha_hora','id_motivo','id_medico','id_estado'];

  const MESSAGES = {
    medico: 'Selecciona un médico de la lista.',
    estado: 'Selecciona el estado de la cita.',
    fecha_hora: 'Ingresa una fecha y hora válidas y futuras.',
    motivo: 'Escribe el motivo (mínimo 5 caracteres).'
  };

  let submittedOnce = false;

  function setMsg(el, text, invalid) {
    const fb = el.parentElement.querySelector('.invalid-feedback');
    if (fb) { fb.textContent = text; fb.style.display = invalid ? 'block' : 'none'; }
    el.classList.toggle('is-invalid', invalid);
  }

  function validateOne(el) {
    const name = el.name;
    const val = (el.value || '').trim();

    if (name === 'medico') { if (!val) return setMsg(el, MESSAGES.medico, true), false; }
    if (name === 'estado') { if (!val) return setMsg(el, MESSAGES.estado, true), false; }

    if (name === 'fecha_hora') {
      if (!val) return setMsg(el, 'Este campo es obligatorio.', true), false;
      const dt = new Date(val);
      if (isNaN(dt.getTime())) return setMsg(el, 'Formato de fecha/hora inválido.', true), false;
      if (dt < new Date()) return setMsg(el, 'La fecha y hora no puede ser en el pasado.', true), false;
    }

    if (name === 'motivo') {
      if (val.length < 5) return setMsg(el, MESSAGES.motivo, true), false;
    }

    setMsg(el, '', false); return true;
  }

  const form = document.querySelector('form');
  form.setAttribute('novalidate','novalidate');

  // Oculta feedback mientras se edita, hasta el primer submit
  FIELDS.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    ['input','change','blur'].forEach(ev => el.addEventListener(ev, () => {
      if (submittedOnce) validateOne(el);
      else setMsg(el, '', false);
    }));
  });

  // Al enviar: valida y muestra mensajes
  form.addEventListener('submit', (e) => {
    submittedOnce = true;
    const results = FIELDS.map(id => {
      const el = document.getElementById(id);
      return el ? validateOne(el) : true;
    });
    if (!results.every(Boolean)) {
      e.preventDefault();
      const first = document.querySelector('.is-invalid');
      if (first) first.focus({preventScroll:false});
      form.scrollIntoView({behavior:'smooth', block:'start'});
    }
  });
</script>
{% endblock %}