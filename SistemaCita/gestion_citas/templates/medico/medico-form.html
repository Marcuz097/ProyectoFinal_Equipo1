{% extends "base.html" %}
{% load static %}

{% block titulo %} 
    {% if form.instance.pk %}
        Editar Medico: {{ form.instance.usuario.first_name }} {{ form.instance.usuario.last_name }}
    {% else %}
        Registrar Nuevo Médico
    {% endif %}
{% endblock %}

{% block extra_css %}
<!-- Carga del nuevo CSS de formulario unificado -->
<link rel="stylesheet" href="{% static 'core/css/CSS-personalizado/medico-form.css' %}">
{% endblock %}

{% block contenido %} 
    
    <!-- AJUSTE CLAVE: Se cambia mt-5 a mt-3 para subir el contenedor. -->
    <div class="container mt-3 d-flex justify-content-center">
        
        <div class="card card-innovadora border-0">
            
            <div class="card-header header-navy text-center">
                <h2 class="card-title">
                    <i class="bi bi-person-badge-fill me-2 text-contrast-blue"></i> 
                    {% if form.instance.pk %}
                        EDITAR MÉDICO
                    {% else %}
                        REGISTRAR NUEVO MÉDICO
                    {% endif %}
                </h2>
            </div>
            
            <form method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                
                <div class="card-body">
                    
                    <div class="row row-compact">
                        
                        {% for field in form %}
                            
                            <div class="col-12 
                                {% if field.name == 'matricula' or field.name == 'telefono' %}
                                    col-md-6 
                                {% endif %}"
                                 >
                                
                                <div class="form-group-elegant">
                                    <label for="{{ field.id_for_label }}" class="text-main-blue">
                                        {# Íconos de acento verde #}
                                        {% if field.name == 'usuario' %}
                                            <i class="bi bi-person-circle me-1 text-contrast-blue"></i> 
                                        {% elif field.name == 'matricula' %}
                                            <i class="bi bi-credit-card-2-front-fill me-1 text-contrast-blue"></i> 
                                        {% elif field.name == 'telefono' %}
                                            <i class="bi bi-telephone-fill me-1 text-contrast-blue"></i> 
                                        {% elif field.name == 'especialidades' %}
                                            <i class="bi bi-journal-medical me-1 text-contrast-blue"></i> 
                                        {% endif %}
                                        {{ field.label }}
                                    </label>
                                    
                                    {% if field.errors %}
                                        <div class="errorlist">{{ field.errors }}</div>
                                    {% endif %}
                                    
                                    {% if field.field.widget.input_type == 'select' or field.field.widget.input_type == 'select multiple' %}
                                        <select name="{{ field.name }}" id="{{ field.id_for_label }}"
                                                class="form-select form-control-styled" 
                                                {% if field.field.widget.input_type == 'select multiple' %}multiple{% endif %}
                                                {% if field.field.required %}required{% endif %}>
                                            
                                            {% if field.name == 'usuario' %}
                                                <option value="" {% if not field.value %}selected{% endif %} disabled>
                                                    -- Seleccionar Usuario --
                                                </option>
                                            {% endif %}
                                            
                                            {% for value, label in field.field.choices %}
                                                {% if value %} 
                                                    <option value="{{ value }}" 
                                                            {% if field.value|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>
                                                        {{ label }}
                                                    </option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    {% else %}
                                        <input type="{{ field.field.widget.input_type|default:'text' }}" 
                                                name="{{ field.name }}" 
                                                id="{{ field.id_for_label }}" 
                                                class="form-control-styled" 
                                                placeholder="{{ field.field.widget.attrs.placeholder|default:'' }}"
                                                value="{{ field.value|default_if_none:'' }}"
                                                {% if field.field.required %}required{% endif %}>
                                    {% endif %}
                                    
                                    {% if field.help_text %}<small class="form-text text-muted">{{ field.help_text }}</small>{% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <div class="footer-buttons d-flex justify-content-center gap-4">
                        <button type="submit" class="btn btn-principal">
                            <i class="bi bi-save-fill me-1"></i> 
                            {% if form.instance.pk %}
                                Actualizar
                            {% else %}
                                Guardar
                            {% endif %}
                        </button>
                        
                        <a href="{% url 'gestion_citas:medico-list' %}" class="btn btn-secundario">
                            <i class="bi bi-x-circle-fill me-1"></i> 
                            Cancelar
                        </a>
                    </div>
                    
                </div>
            </form>
        </div>
    </div>

<script>
// Script para habilitar la validación de formularios nativa de Bootstrap (Se mantiene)
(function () {
  'use strict'
  var form = document.querySelector('form')
  if (form) {
    form.addEventListener('submit', function (event) {
      if (!form.checkValidity()) {
        event.preventDefault()
        event.stopPropagation()
      }
      form.classList.add('was-validated')
    }, false)
  }
})()
</script>
{% endblock %}